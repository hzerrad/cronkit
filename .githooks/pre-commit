#!/bin/bash

# Pre-commit hook for Go projects
# Enforces go fmt, go vet, golangci-lint, and optionally tests
#
# Configuration (set via environment variables):
# - SKIP_TESTS=1        : Skip running tests in pre-commit hook
# - RUN_TESTS=1         : Always run unit tests (default: only if test files changed)

set -e

echo "Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get list of staged Go files
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

if [ -z "$STAGED_GO_FILES" ]; then
    echo -e "${GREEN}✓${NC} No Go files to check"
    exit 0
fi

echo "Checking Go files: $STAGED_GO_FILES"

# Check 1: go fmt
echo -e "\n${YELLOW}Running go fmt...${NC}"
UNFORMATTED_FILES=$(gofmt -l $STAGED_GO_FILES)
if [ -n "$UNFORMATTED_FILES" ]; then
    echo -e "${RED}✗${NC} The following files are not formatted:"
    echo "$UNFORMATTED_FILES"
    echo ""
    echo "Please run: make fmt"
    echo "Or run: gofmt -w $UNFORMATTED_FILES"
    exit 1
fi
echo -e "${GREEN}✓${NC} All files are properly formatted"

# Check 2: go vet
echo -e "\n${YELLOW}Running go vet...${NC}"
if ! go vet ./...; then
    echo -e "${RED}✗${NC} go vet found issues"
    echo "Please fix the issues before committing"
    exit 1
fi
echo -e "${GREEN}✓${NC} go vet passed"

# Check 3: golangci-lint (if available)
echo -e "\n${YELLOW}Running golangci-lint...${NC}"
if ! command -v golangci-lint &> /dev/null; then
    echo -e "${YELLOW}⚠${NC}  golangci-lint not found, skipping lint check"
    echo "Install it from: https://golangci-lint.run/usage/install/"
else
    if ! golangci-lint run ./...; then
        echo -e "${RED}✗${NC} golangci-lint found issues"
        echo "Please fix the issues before committing"
        exit 1
    fi
    echo -e "${GREEN}✓${NC} golangci-lint passed"
fi

# Check 4: Unit tests (conditional)
if [ "$SKIP_TESTS" != "1" ]; then
    # Check if any test files are being committed or if RUN_TESTS is set
    TEST_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '_test\.go$' || true)

    if [ -n "$TEST_FILES" ] || [ "$RUN_TESTS" = "1" ]; then
        echo -e "\n${YELLOW}Running unit tests...${NC}"
        echo -e "${BLUE}Tip: Set SKIP_TESTS=1 to skip tests in pre-commit hook${NC}"

        if ! go test -short -race ./internal/... ./pkg/... 2>&1; then
            echo -e "${RED}✗${NC} Unit tests failed"
            echo "Please fix failing tests before committing"
            echo ""
            echo "To skip tests temporarily, use:"
            echo "  SKIP_TESTS=1 git commit"
            exit 1
        fi
        echo -e "${GREEN}✓${NC} Unit tests passed"
    else
        echo -e "\n${BLUE}ℹ${NC}  No test files modified, skipping tests"
        echo -e "  Set RUN_TESTS=1 to always run tests"
    fi
else
    echo -e "\n${YELLOW}⚠${NC}  Skipping tests (SKIP_TESTS=1)"
fi

# All checks passed
echo -e "\n${GREEN}✓ All pre-commit checks passed!${NC}\n"
exit 0
